function slice(c,b,a){return Array.prototype.slice.call(c,b,a)}function keys(a){return Object.keys(a)}function Log(a){this.log=[];this.count=0;this.size=a||1024}Log.prototype.clear=function(){this.log=[]};Log.prototype.push=function(a){if(this.size<this.log.length){this.log.shift()}this.log.push((this.count++)+": "+a)};Log.prototype.print=function(b){var a;for(a=0;a<this.log.length;a++){console.log(this.log[a])}};function Strace(a){this.strace=[];this.size=a||1024}Strace.prototype.push=function(a){if(this.size<this.strace.length){this.strace.shift()}this.strace.push(a);return this.strace.length-1};Strace.prototype.pop=function(a){while(this.strace.length>a){this.strace.pop()}return this.strace.length};Strace.prototype.clear=function(){this.strace=[]};Strace.prototype.willstrace=function(d,c){var b=this;return function a(){var e;var f;var g;g=d+this.toLisp();f=b.push(g);e=c.apply(this,arguments);b.pop(f);return e}};Strace.prototype.unwindstrace=function(c){var b,a=this;return function d(){try{b=c.apply(this,arguments)}catch(e){a.print();throw e}return b}};Strace.prototype.print=function(){var b,a;for(b="lisa trace:\n",a=0;a<this.strace.length;a++){b+="    "+a+": "+this.strace[a]+"\n"}console.log(b)};var strace=new Strace();var stracedb=new Strace();function Unique(){}function NameGenerator(a){this.source=a;this.index=0}NameGenerator.prototype.generate=function(){var b="";var a=this.index++;var c=this.source;do{b+=c[a%c.length];a=a/c.length|0}while(a);return b};function NameGeneratorIgnore(a,b){this.source=a;this.index=0;this.ignores=b}NameGeneratorIgnore.prototype.generate=function(){var a;while(this.ignores.indexOf((a=NameGenerator.prototype.generate.call(this)))>=0){}return a};function Constantable(){}Constantable.prototype.constantable=false;Constantable.prototype.constant=function(){this.constantable=true;return this};Constantable.prototype.notconstant=function(){this.constantable=false;return this};Constantable.prototype.inherit=function(a){this.constantable=a.isconstant();return this};Constantable.prototype.isconstant=function(){return this.constantable};Constantable.prototype.isnotconstant=function(){return this.isconstant()==false};function Evaluatable(){}Evaluatable.prototype=Object.create(Constantable.prototype);Evaluatable.prototype.onevaluate=null;Evaluatable.prototype.onevaluatearg=null;Evaluatable.prototype.onevaluatedata=null;function evaluate(a){if(a instanceof Evaluatable==false){throw new Error(""+a+" is not evaluatable")}return a.evaluate.apply(a,arguments)}function evaluatearg(a){if(a instanceof Evaluatable==false){throw new Error(""+a+" is not evaluatable")}return a.evaluatearg.apply(a,arguments)}function evaluatedata(a){if(a instanceof Evaluatable==false){throw new Error(""+a+" is not evaluatable")}return a.evaluatedata.apply(a,arguments)}function beforeevaluate(b){return function a(){return b.apply(this,slice(arguments).map(evaluate))}}function beforeevaluatearg(b){return function a(){return b.apply(this,slice(arguments).map(evaluatearg))}}function beforeevaluatedata(a){return function b(){return a.apply(this,slice(arguments).map(evaluatedata))}}function afterevaluate(a){return function b(){return a.apply(this,arguments).evaluate()}}function afterevaluatearg(b){return function a(){return b.apply(this,arguments).evaluatearg()}}function afterevaluatedata(b){return function a(){return b.apply(this,slice(arguments).map(evaluatedata))}}Evaluatable.prototype.evaluate=function(){if(this.onevaluate==null){throw new Error(""+this+" onevaluate was not defined.")}return this.onevaluate.apply(this,arguments)};Evaluatable.prototype.evaluatearg=function(){if(this.onevaluatearg==null){throw new Error(""+this+" onevaluatearg was not defined.")}return this.onevaluatearg()};Evaluatable.prototype.evaluate=strace.willstrace("evaluate <- ",Evaluatable.prototype.evaluate);Evaluatable.prototype.evaluatedata=function(){if(this.onevaluatedata==null){return this.evaluatearg()}return this.onevaluatedata()};Evaluatable.prototype.willevaluate=function(){var a=this;return function b(){return a.evaluate.apply(a,arguments)}};Evaluatable.prototype.willevaluatearg=function(){var a=this;return function b(){return a.evaluatearg.apply(a,arguments)}};function Expandable(){}Expandable.prototype=Object.create(Evaluatable.prototype);Expandable.prototype.onexpand=null;Expandable.prototype.onexpandarg=null;Expandable.prototype.onexpanddata=null;function expand(a){if(a instanceof Expandable==false){throw new Error(""+a+" is not expandable")}return a.expand.apply(a,arguments)}function expandarg(a){if(a instanceof Expandable==false){throw new Error(""+a+" is not expandable")}return a.expandarg.apply(a,arguments)}function expanddata(a){if(a instanceof Expandable==false){throw new Error(""+a+" is not expandable")}return a.expanddata.apply(a,arguments)}function beforeexpand(a){return function b(){return a.apply(this,slice(arguments).map(expand))}}function beforeexpandarg(a){return function b(){return a.apply(this,slice(arguments).map(expandarg))}}function beforeexpanddata(a){return function b(){return a.apply(this,slice(arguments).map(expanddata))}}function afterexpand(a){return function b(){return a.apply(this,arguments).expand()}}function afterexpandarg(a){return function b(){return a.apply(this,arguments).expandarg()}}function afterexpanddata(b){return function a(){return b.apply(this,arguments).expanddata()}}Expandable.prototype.expand=function(){if(this.onexpand==null){throw new Error(""+this+" onexpand was not defined.")}return this.onexpand.apply(this,arguments)};Expandable.prototype.expandarg=function(){if(this.onexpandarg==null){throw new Error(""+this+"onexpandarg was not defined.")}return this.onexpandarg()};Expandable.prototype.expanddata=function(){if(this.onexpanddata==null){return this.expandarg()}return this.onexpanddata()};Expandable.prototype.willexpand=function(){var b=this;return function a(){return b.expand.apply(b,arguments)}};Expandable.prototype.willexpandarg=function(){var a=this;return function b(){return a.expandarg.apply(a,arguments)}};Expandable.prototype.willexpanddata=function(){var b=this;return function a(){return b.expanddata.apply(b,arguments)}};function Expanded(a){this.value=a||""}Expanded.prototype=Object.create(Expandable.prototype);Expanded.prototype.toString=function(){return this.value};Expanded.prototype.toLisp=Expanded.prototype.toString;Expanded.prototype.expand=function(){return new Expanded(this.value+"("+slice(arguments).map(expandarg).join(",")+")")};Expanded.prototype.onevaluatearg=function(){return this};Expanded.prototype.onexpandarg=function(){return this};Expanded.prototype.unpack=function(){return this.value};function unpack(a){if(a instanceof Expanded==false){throw new Error("some is not expanded.")}return a.unpack()}function makeexpanded(a){return new Expanded(a)}function AtomClass(a){this.value=a}AtomClass.prototype=Object.create(Expandable.prototype);AtomClass.prototype.toString=function(){return this.value.toString()};AtomClass.prototype.toLisp=function(){return this.toString()};AtomClass.prototype.toPlain=function(){return this.toString()};AtomClass.prototype.valueOf=function(){return this.toString()};AtomClass.prototype.onevaluatearg=function(){return this};AtomClass.prototype.onevaluatedata=function(){return this};AtomClass.prototype.onexpandarg=function(){return new Expanded(this.toString())};AtomClass.prototype.status=function(){return true};AtomClass.prototype.clone=function(){return this};function value(a){if(a instanceof AtomClass==false){throw new Error(""+a+" is not atom class.")}return a.value}function tostring(a){if(a instanceof AtomClass==false){throw new Error(""+a+" is not atom class.")}return a.toString()}function tolisp(a){if(a instanceof AtomClass==false){throw new Error(""+a+" is not atom class.")}return a.toLisp()}function toplain(a){if(a instanceof AtomClass==false){throw new Error(""+a+"is not atom class.")}return a.toplain()}function clone(a){if(a instanceof AtomClass==false){throw new Error(""+a+" is not atom class.")}return a.clone()}function beforeclone(b){return function a(){return b.apply(b,slice(arguments).map(clone))}}function afterclone(b){return function a(){return b.apply(b,arguments).clone()}}function TrueClass(){}TrueClass.prototype=Object.create(AtomClass.prototype);TrueClass.prototype.toString=function(){return"true"};TrueClass.prototype.toLisp=function(){return"t"};TrueClass.prototype.status=function(){return true};var t=new TrueClass();function ReferenceClass(){}ReferenceClass.prototype=Object.create(AtomClass.prototype);ReferenceClass.prototype.toString=function(){return this.get().toString()};ReferenceClass.prototype.toLisp=function(){return this.get().toLisp()};ReferenceClass.prototype.get=function(){throw new Error("reference "+this.toLisp()+"get has not defined yet.")};ReferenceClass.prototype.set=function(){throw new Error("reference "+this.toLisp()+"set has not defined yet.")};ReferenceClass.prototype.onevaluatearg=function(){return this.get().evaluatearg()};ReferenceClass.prototype.onexpandarg=function(){return this.get().expandarg()};ReferenceClass.prototype.onevaluate=function(){var a=this.get();return a.evaluate.apply(a,arguments)};ReferenceClass.prototype.onexpand=function(){var a=this.get();return a.expand.apply(a,arguments)};function getreference(a){return a instanceof ReferenceClass?a.get():a}function beforegetreference(b){return function a(){return b.apply(this,slice(arguments).map(getreference))}}function aftergetreference(a){return function b(){return getreference(a.apply(this,arguments))}}function ArrayReferenceClass(b,a){this.value=b||null;this.index=a}ArrayReferenceClass.prototype=Object.create(ReferenceClass.prototype);ArrayReferenceClass.prototype.get=function(){return this.value.evaluatedata().get(this.index)};ArrayReferenceClass.prototype.set=function(a){return this.value.evaluatedata().set(this.index,a)};ArrayReferenceClass.prototype.onexpanddata=function(){return new Expanded(this.value.expanddata().unpack()+"["+this.index+"]")};function ConsReferenceClass(a){this.cons=a}ConsReferenceClass.prototype=Object.create(ReferenceClass.prototype);ConsReferenceClass.prototype.get=function(){return this.cons};ConsReferenceClass.prototype.getcar=function(){return this.get().getcar()};ConsReferenceClass.prototype.getcdr=function(){return this.get().getcdr()};ConsReferenceClass.prototype.setcar=function(a){return this.get().setcar(a)};ConsReferenceClass.prototype.setcdr=function(a){return this.get().setcdr(a)};ConsReferenceClass.prototype.getcar=function(){return this.get().getcar()};ConsReferenceClass.prototype.getcdr=function(){return this.get().getcdr()};function makeconsreference(a){return new ConsReferenceClass(a)}function ConsCarReferenceClass(a){ConsReferenceClass.apply(this,arguments)}ConsCarReferenceClass.prototype=Object.create(ConsReferenceClass.prototype);ConsCarReferenceClass.prototype.get=function(){return this.cons.getcar()};ConsCarReferenceClass.prototype.set=function(a){return this.get().setcar(a)};ConsCarReferenceClass.prototype.onexpandarg=function(){return new Expanded(this.cons.expandarg()+".car")};function makeconscarreference(a){return new ConsCarReferenceClass(a)}function ConsCdrReferenceClass(){ConsReferenceClass.apply(this,arguments)}ConsCdrReferenceClass.prototype=Object.create(ConsReferenceClass.prototype);ConsCdrReferenceClass.prototype.get=function(){return this.cons.getcdr()};ConsCdrReferenceClass.prototype.set=function(a){return this.get().setcdr(a)};ConsCdrReferenceClass.prototype.onexpandarg=function(){return new Expanded(this.cons.expandarg()+".cdr")};function makeconscdrreference(a){return new ConsCdrReferenceClass(a)}function SymbolReferenceClass(a){this.value=a}SymbolReferenceClass.prototype=Object.create(ReferenceClass.prototype);function SymbolValueReferenceClass(){SymbolReferenceClass.apply(this,arguments)}SymbolValueReferenceClass.prototype=Object.create(SymbolReferenceClass.prototype);SymbolValueReferenceClass.prototype.get=function(){return this.value.getvalue()};SymbolValueReferenceClass.prototype.set=function(a){return this.value.setvalue(a)};SymbolValueReferenceClass.prototype.onexpandarg=function(){return this.value.getvarname()};function SymbolFunctionReferenceClass(){SymbolReferenceClass.apply(this,arguments)}SymbolFunctionReferenceClass.prototype=Object.create(SymbolReferenceClass.prototype);SymbolFunctionReferenceClass.prototype.get=function(){return this.value.getfunc()};SymbolFunctionReferenceClass.prototype.set=function(a){return this.value.setfunc(a)};SymbolFunctionReferenceClass.prototype.onexpandarg=function(){return this.value.getfuncname()};function NumberClass(a){this.value=a}NumberClass.prototype=Object.create(AtomClass.prototype);NumberClass.prototype.clone=function(){return new NumberClass(this.value)};function FloatClass(a){this.value=a}FloatClass.prototype=Object.create(NumberClass.prototype);FloatClass.prototype.clone=function(){return new FloatClass(this.value)};function makefloat(a){return new FloatClass(a)}function IntClass(a){this.value=a}IntClass.prototype=Object.create(NumberClass.prototype);IntClass.prototype.clone=function(){return new IntClass(this.value)};function makeint(a){return new IntClass(a)}function CharClass(a){this.value=a}CharClass.prototype=Object.create(IntClass.prototype);CharClass.prototype.toString=function(){return String.fromCharCode(this.value)};CharClass.prototype.toLisp=function(){return"?"+String.fromCharCode(this.value)};CharClass.prototype.clone=function(){return new CharClass(this.value)};CharClass.prototype.add=function(a){if(a instanceof IntClass==false){throw new Error("num "+a+" is not int class.")}return new CharClass(this.value+a.value)};CharClass.prototype.sub=function(a){if(a instanceof IntClass==false){throw new Error("num "+a+" is not int class.")}return new CharClass(this.value-a.value)};CharClass.prototype.mul=function(a){if(a instanceof IntClass==false){throw new Error("num "+a+" is not int class.")}return new CharClass(this.value*a.value)};CharClass.prototype.div=function(a){if(a instanceof IntClass==false){throw new Error("num "+a+" is not int class.")}return new CharClass(this.value/a.value)};CharClass.prototype.mod=function(a){if(a instanceof IntClass==false){throw new Error("num "+a+" is not int class.")}return new CharClass(this.value%a.value)};function atoi(a){return a.charCodeAt()}function atoc(a){return new CharClass(atoi(a))}function SequencialClass(){}SequencialClass.prototype=Object.create(AtomClass.prototype);SequencialClass.prototype.get=function(){throw new Error("get was not defined.")};SequencialClass.prototype.set=function(){throw new Error("set was not defined.")};SequencialClass.prototype.toArray=function(){throw new Error("toArray was not defined.")};SequencialClass.prototype.toPlain=function(){throw new Error("toPlain was not defined.")};SequencialClass.prototype.every=function(){throw new Error("every was not defined.")};SequencialClass.prototype.map=function(){throw new Error("map was not defined.")};SequencialClass.prototype.filter=function(){throw new Error("filter was not defined.")};SequencialClass.prototype.reduce=function(){throw new Error("reduce was not defined.")};SequencialClass.prototype.findif=function(){throw new Error("findif was not defined.")};SequencialClass.prototype.positionif=function(){throw new Error("positionif was not defined.")};SequencialClass.prototype.reverse=function(){throw new Error("reverse was not defined.")};SequencialClass.prototype.concat=function(){throw new Error("concat was not defined.")};SequencialClass.prototype.slice=function(){throw new Error("slice was not defined.")};SequencialClass.prototype.copy=function(){throw new Error("clone was not defined.")};SequencialClass.prototype.nth=function(){throw new Error("nth was not defined.")};SequencialClass.prototype.last=function(){throw new Error("last was not defined.")};SequencialClass.prototype.length=function(){throw new Error("length was not defined.")};SequencialClass.prototype.iter=function(){throw new Error("iter was not defined.")};SequencialClass.prototype.push=function(){throw new Error("push was not defined.")};SequencialClass.prototype.pop=function(){throw new Error("pop was not defined.")};function ArrayClass(a){this.value=a}ArrayClass.prototype=Object.create(SequencialClass.prototype);ArrayClass.prototype.get=function(a){return this.value[a]};ArrayClass.prototype.set=function(a,b){this.value[a]=b;return b};ArrayClass.prototype.length=function(){return this.value.length};ArrayClass.prototype.toArray=function(){return this.value};ArrayClass.prototype.toPlain=function(){return""+this.value.map(toplain).join(",")+""};ArrayClass.prototype.toString=function(){return"["+this.value.map(tostring).join(",")+"]"};ArrayClass.prototype.toLisp=function(){return"#("+this.value.map(tolisp).join(" ")+")"};function ClassArrayClass(a){this.value=a}ClassArrayClass.prototype=Object.create(ArrayClass.prototype);function StringClass(a){this.value=a||[]}StringClass.prototype=Object.create(ClassArrayClass.prototype);StringClass.prototype.toString=function(){return'"'+this.value.join("")+'"'};StringClass.prototype.toPlain=function(){return""+this.value.join("")+""};StringClass.prototype.toLisp=function(){return this.toString()};StringClass.prototype.copy=function(){return new StringClass(this.value.slice())};function makestring(a){return new StringClass(slice(a).map(atoc))}function ConsClass(a,b){this.car=a||nil;this.cdr=b||nil}ConsClass.prototype=Object.create(SequencialClass.prototype);ConsClass.prototype.getcar=function(){return this.car};ConsClass.prototype.getcdr=function(){return this.cdr};ConsClass.prototype.setcar=function(a){this.car=a;return a};ConsClass.prototype.setcdr=function(a){this.cdr=a;return a};ConsClass.prototype.toPlain=function(){return""+this.toArray().map(tostring).join(",")+""};ConsClass.prototype.toLisp=function(){return"("+this.toArray().map(tolisp).join(" ")+")"};ConsClass.prototype.toString=function(){return"["+this.toArray().map(tostring).join(",")+"]"};ConsClass.prototype.onexpand=function(){var a=this.expandarg();return a.expand.apply(a,arguments)};ConsClass.prototype.onevaluate=function(){var a=this.evaluatearg();return a.evaluate.apply(a,arguments)};ConsClass.prototype.onexpandarg=function(){var b=this.car;var a=this.cdr.toArray();return b.expand.apply(b,a)};ConsClass.prototype.onevaluatearg=function(){var b=this.car;var a=this.cdr.toArray();return b.evaluate.apply(b,a)};ConsClass.prototype.onexpanddata=function(){return new Expanded(this.toString())};ConsClass.toCons=function(c){var a,b;for(a=nil,b=0;b<c.length;b++){a=makecons(c[b],a)}return a.reverse()};ConsClass.prototype.toCons=function(){return this};ConsClass.prototype.clone=function(){var b,a;for(b=nil,a=this;a!=nil;a=a.cdr){if(a.car instanceof UnQuoteAtClass){var d,c;for(d=a.car.clone().reverse(),c=d;c!=nil&&c.cdr!=nil;c=c.cdr){}c.cdr=b;b=d}else{if(a.car instanceof UnQuoteClass){b=makecons(a.car.clone(),b)}else{b=makecons(a.car.clone(),b)}}}return b.reverse()};ConsClass.prototype.toArray=function(){this.shouldlinear();var b,a;for(b=[],a=this;a!=nil;a=a.cdr){b.push(a.car)}return b};ConsClass.prototype.reverse=function(){var a,c,b;for(a=this,b=nil;a!=nil;){c=a.cdr;a.cdr=b;b=a;a=c}return b};ConsClass.prototype.islinear=function(){var a;for(a=this;a!=nil;a=a.cdr){if(a.cdr!=nil&&a.cdr instanceof ConsClass==false){return false}}return true};ConsClass.prototype.shouldlinear=function(){if(this.islinear()==false){throw ("list should be linear.")}};function makecons(a,b){return new ConsClass(a,b)}function makelist(){return ConsClass.toCons(arguments)}function NilClass(){}NilClass.prototype=Object.create(ConsClass.prototype);NilClass.prototype.car=nil;NilClass.prototype.cdr=nil;NilClass.prototype.getcar=function(){return nil};NilClass.prototype.getcdr=function(){return nil};NilClass.prototype.setcar=function(){throw new Error("nil cannot setcar.")};NilClass.prototype.setcdr=function(){throw new Error("nil cannot setcdr.")};NilClass.prototype.onevaluatearg=function(){return this};NilClass.prototype.onexpandarg=function(){return new Expanded(this.toString())};NilClass.prototype.onevaluate=NilClass.prototype.onevaluatearg;NilClass.prototype.onexpand=NilClass.prototype.onexpandarg;NilClass.prototype.status=function(){return false};NilClass.prototype.toLisp=function(){return"nil"};NilClass.prototype.toString=function(){return"null"};var nil=new NilClass();function QuoteFamilyClass(a){this.value=a}QuoteFamilyClass.prototype=Object.create(AtomClass.prototype);function UnQuoteClass(a){this.value=a}UnQuoteClass.prototype=Object.create(QuoteFamilyClass.prototype);UnQuoteClass.prototype.onexpand=function(){throw new Error("unquote cannot expand")};UnQuoteClass.prototype.onevaluate=function(){throw new Error("unquote is cannot evaluate")};UnQuoteClass.prototype.onexpandarg=function(){throw new Error("unquote cannot expandarg")};UnQuoteClass.prototype.onevaluatearg=function(){throw new Error("unquote is cannot evaluatearg")};UnQuoteClass.prototype.toString=function(){return"/*--unquote--*/"+this.value.toString()};UnQuoteClass.prototype.toLisp=function(){return","+this.value.toLisp()};UnQuoteClass.prototype.clone=function(){return getreference(this.value.evaluatearg())};function makeunquote(a){return new UnQuoteClass(a)}function UnQuoteAtClass(a){this.value=a}UnQuoteAtClass.prototype=Object.create(UnQuoteClass.prototype);UnQuoteAtClass.prototype.onexpand=function(){throw new Error("unquoteat cannot expand")};UnQuoteAtClass.prototype.onevaluate=function(){throw new Error("unquoteat is cannot evaluate")};UnQuoteAtClass.prototype.onexpandarg=function(){throw new Error("unquoteat cannot expandarg")};UnQuoteAtClass.prototype.onevaluatearg=function(){throw new Error("unquoteat is cannot evaluatearg")};UnQuoteAtClass.prototype.toString=function(){return"/*--unquoteat--*/"+this.value.toString()};UnQuoteAtClass.prototype.toLisp=function(){return",@"+this.value.toLisp()};function makeunquoteat(a){return new UnQuoteAtClass(a)}function CallableClass(){}CallableClass.prototype=Object.create(AtomClass.prototype);CallableClass.prototype.label="<#callable class>";CallableClass.prototype.toString=function(){return this.label};function FunctionClass(){}FunctionClass.prototype=Object.create(CallableClass.prototype);FunctionClass.prototype.label="<#function class>";function SpecialFunctionClass(){}SpecialFunctionClass.prototype=Object.create(FunctionClass.prototype);SpecialFunctionClass.prototype.evaluate=strace.willstrace("evaluate special function = ",SpecialFunctionClass.prototype.evaluate);SpecialFunctionClass.prototype.expand=strace.willstrace("expand special function = ",SpecialFunctionClass.prototype.expand);SpecialFunctionClass.label="<#special function class>";function PrimitiveFunctionClass(){}PrimitiveFunctionClass.prototype=Object.create(FunctionClass.prototype);PrimitiveFunctionClass.prototype.evaluate=beforeevaluatearg(beforegetreference(FunctionClass.prototype.evaluate));PrimitiveFunctionClass.prototype.expand=beforeexpandarg(beforegetreference(FunctionClass.prototype.expand));PrimitiveFunctionClass.prototype.label="<#primitive function class>";function UserFunctionClass(a,b){this.args=a||null;this.rest=b||null}UserFunctionClass.prototype=Object.create(FunctionClass.prototype);UserFunctionClass.prototype.toLisp=function(){return makecons(synlambda,makecons(this.args,this.rest)).toLisp()};UserFunctionClass.prototype.onevaluate=function(){var b;var f,e;b="";f=this.args;e=ConsClass.toCons(arguments);for(;f!=nil&&e!=nil;f=f.cdr,e=e.cdr){if(f.car==rest){break}if(f.car==optional){break}b=makecons(makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,f.car))),e.car),b)}if(f.car==makeintern("&optional")){f=f.cdr;for(;f!=nil&&e!=nil;f=f.cdr,e=e.cdr){if(f.car==rest){break}var a=f.car instanceof ConsClass?f.car.car:f.car;var d=f.car instanceof ConsClass?e?e.car:f.car.cdr.car:e?e.car:nil;b=makecons(makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,a))),d),b)}}if(f.car==makeintern("&rest")){f=f.cdr;b=makecons(makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,f.car))),makecons(basconlist,e)),b)}var g=makelist(synblock,makecons(synprogn,b.reverse()),makecons(synprogn,this.rest));var c="user function <- "+g.toLisp();strace.push(c);stracedb.push(c);return g.evaluatearg()};UserFunctionClass.prototype.onexpandarg=function(){var a=this.args;var b=0;var c="";inp.nest();for(;a!=nil;a=a.cdr){if(a.car==makeintern("&rest")){break}if(a.car==makeintern("&optional")){break}inp.scopevar.addf(a.car,a.car);c+="var "+a.car+"=arguments["+(b++)+"];"}if(a.car==makeintern("&optional")){a=a.cdr;for(;a!=nil;a=a.cdr){if(a.car==makeintern("&rest")){break}inp.scopevar.addf(a.car,a.car);c+="var "+a.car+"=arguments["+(b++)+"]||null;"}}if(a.car==makeintern("&rest")){a=a.cdr;inp.scopevar.addf(a.car,a.car);c+="var "+a.car+"=Array.prototype.slice.call(arguments, "+(b++)+"]"}c=new Expanded("function(){"+c+"return "+makecons(synprogn,this.rest).expandarg()+"}");inp.exit();return c};function MacroClass(){}MacroClass.prototype=Object.create(CallableClass.prototype);MacroClass.prototype.toString=function(){return nil.toString()};MacroClass.prototype.evaluate=beforegetreference(aftergetreference(afterevaluatearg(CallableClass.prototype.evaluate)));MacroClass.prototype.expand=beforegetreference(aftergetreference(afterexpandarg(CallableClass.prototype.evaluate)));function PrimitiveMacroClass(){}PrimitiveMacroClass.prototype=Object.create(MacroClass.prototype);function UserMacroClass(a,b){this.args=a||null;this.rest=b||null}UserMacroClass.prototype=Object.create(MacroClass.prototype);UserMacroClass.prototype.toLisp=function(){return makelist(synmacro,this.args,this.rest).toLisp()};UserMacroClass.prototype.onevaluate=function(){var c,f,e;c=makecons(synprogn);f=this.args;e=ConsClass.toCons(arguments);for(;f!=nil&&e!=nil;f=f.cdr,e=e.cdr){if(f.car==makeintern("&rest")){break}if(f.car==makeintern("&optional")){break}c=makecons(makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,f.car))),makelist(synquote,e.car)),c)}if(f.car==makeintern("&optional")){f=f.cdr;for(;f!=nil&&e!=nil;f=f.cdr,e=e.cdr){if(f.car==makeintern("&rest")){break}c=makecons(makecons(makeintern("defvar"),(e==nil)?(f.car instanceof ConsClass==false)?(makecons(f.car,makecons(nil))):(makecons(f.car.car,makecons(f.car.cdr.car))):(f.car instanceof ConsClass==false)?(makecons(f.car,makecons(makelist(synquote,e.car)))):(makecons(f.car.car,makecons(makelist(synquote,e.car))))),c)}}if(f.car==makeintern("&rest")){f=f.cdr;c=makecons(makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,f.car))),makelist(synquote,e)),c)}c=c.reverse();var g=makecons(synblock,makecons(c,this.rest));var d="user function <- "+g.toLisp();strace.push(d);stracedb.push(d);var a=g.evaluatearg();var b="macro expantion <- "+a.toLisp();strace.push(b);stracedb.push(b);return a};var logmadesymbols=new Log();function SymbolFamilyClass(a){if(a instanceof StringClass==false&&a instanceof NilClass==false){throw new Error(""+a+" is should be nil or string instance.")}logmadesymbols.push(a.toLisp());this.name=a}SymbolFamilyClass.prototype=Object.create(AtomClass.prototype);SymbolFamilyClass.prototype.toString=function(){return this.name.toPlain()};SymbolFamilyClass.prototype.toPlain=function(){return this.name.toPlain()};SymbolFamilyClass.prototype.toLisp=function(){return this.toString()};SymbolFamilyClass.prototype.getvalue=function(){throw new Error("getvalue has not defined yet in symbol family class.")};SymbolFamilyClass.prototype.getfunc=function(){throw new Error("getfunc has not defined yet in symbol family class.")};SymbolFamilyClass.prototype.getfunce=function(){throw new Error("getfunce has not defined yet in symbol family class.")};SymbolFamilyClass.prototype.setvalue=function(){throw new Error("setvalue has not defined yet in symbol family class.")};SymbolFamilyClass.prototype.getvaluee=function(){throw new Error("getvaluee has not defined yet in symbol family class.")};SymbolFamilyClass.prototype.setfunc=function(){throw new Error("setfunc has not defined yet in symbol family class.")};SymbolFamilyClass.prototype.getvarname=function(){throw new Error("getvarname has not defined yet in symbol family class")};SymbolFamilyClass.prototype.getfuncname=function(){throw new Error("getfuncname has not defined yet in symbol family class")};SymbolFamilyClass.prototype.set=function(){return this.setvalue.apply(this,arguments)};SymbolFamilyClass.prototype.get=function(){return this.getvalue.apply(this,arguments)};SymbolFamilyClass.prototype.onevaluatearg=function(){return this.getvalue()};SymbolFamilyClass.prototype.onexpandarg=function(){throw new Error("onexpandarg has not defined yet in symbol family class.")};SymbolFamilyClass.prototype.onevaluate=function(){var a=this.getfunce();return a.evaluate.apply(a,arguments)};SymbolFamilyClass.prototype.onexpand=function(){var a=this.getfunc();if(a&&a instanceof MacroClass||a instanceof SpecialFunctionClass){return a.expand.apply(a,arguments)}return new Expanded(""+this.expandarg()+"("+slice(arguments).map(expandarg).join(",")+")")};function SymbolClass(){SymbolFamilyClass.apply(this,arguments)}SymbolClass.prototype=Object.create(SymbolFamilyClass.prototype);SymbolClass.prototype.setvalue=function(a){return inp.scopevar.set(this,a)};SymbolClass.prototype.setfunc=function(a){return inp.scopefunc.set(this,a)};SymbolClass.prototype.getvalue=function(){return inp.scopevar.get(this)};SymbolClass.prototype.getfunc=function(){return inp.scopefunc.get(this)};SymbolClass.prototype.getvaluee=function(){var a=this.getvalue();if(a==null){throw new Error("symbol "+this+" has no value.")}return a};SymbolClass.prototype.getfunce=function(){var a=this.getfunc();if(a==null){throw new Error("symbol "+this+" has no function.")}return a};SymbolClass.prototype.getvarname=function(){return inp.scopevar.getvarname(this)};SymbolClass.prototype.getfuncname=function(){return inp.scopefunc.getvarname(this)};SymbolClass.prototype.onexpandarg=function(){return new Expanded(this.toString())};var interneds=[];function InternSymbolClass(c){var b;for(b=0;b<interneds.length;b++){if(interneds[b].name.toString()==c.toString()){return interneds[b]}}var a=new SymbolClass(c);interneds.push(a);inp.scopevar.add(a,null);inp.scopefunc.add(a,null);return a}InternSymbolClass.prototype=Object.create(SymbolClass.prototype);function stoc(a){return new CharClass(a.charCodeAt())}function makeintern(a){return new InternSymbolClass(new StringClass(slice(a).map(stoc)))}function StreamClass(a){this.direction=a}StreamClass.prototype=Object.create(AtomClass.prototype);StreamClass.direction={};StreamClass.direction.input=(1|0);StreamClass.direction.output=(2|0);StreamClass.direction.io=StreamClass.direction.input|StreamClass.direction.output;StreamClass.onevaluate=null;StreamClass.onexpand=null;StreamClass.onexpandarg=null;StreamClass.onexpanddata=null;StreamClass.prototype.iseof=function(){throw new Error("iseof was not defined.")};StreamClass.prototype.isalive=function(){throw new Error("isalive was not defined.")};StreamClass.prototype.look=function(){throw new Error("look was not defined.")};StreamClass.prototype.get=function(){throw new Error("get was not defined.")};StreamClass.prototype.put=function(){throw new Error("put was not defined.")};StreamClass.prototype.isin=function(){return new Boolean(this.direction&StreamClass.direction.input)};StreamClass.prototype.isout=function(){return new Boolean(this.direction&StreamClass.direction.output)};StreamClass.prototype.shouldin=function(){if(this.isin()==false){throw new Error("stream should input direction!")}};StreamClass.prototype.shouldout=function(){if(this.isout()==false){throw new Error("stream should output direction!")}};StreamClass.prototype.toString=function(){return"#stream direction: "+(this.isin()==false?"r":"-")+(this.isout()==false?"w":"-")};StreamClass.prototype.toLisp=function(){return this.toString()};function StringStreamClass(b,a){this.direction=b;this.source=a;this.sourceout=new StringClass();this.index=0}StringStreamClass.prototype=Object.create(StreamClass.prototype);StringStreamClass.prototype.iseof=function(){this.shouldin();return this.source.length()<=this.index};StringStreamClass.prototype.isalive=function(){this.shouldin();return this.iseof()==false};StringStreamClass.prototype.look=function(){this.shouldin();return this.iseof()?nil:this.source.get(this.index)};StringStreamClass.prototype.get=function(){this.shouldin();return this.iseof()?nil:this.source.get(this.index++)};StringStreamClass.prototype.put=function(a){this.shouldout();return this.source.push(a)};StringStreamClass.prototype.toString=function(){return StreamClass.prototype.toString.apply(this,arguments)+" :seek "+this.index.toString()+" :source "+this.source.toString()};function makestrstreamin(a){return new StringStreamClass(StreamClass.direction.input,makestring(a))}function makestrstreamout(a){return new StringStreamClass(StreamClass.direction.output,makestring(""))}function ObarrayPair(a,b){if(a instanceof SymbolFamilyClass==false){throw new Error(""+a+" should be symbol family instance.")}if(b&&b instanceof AtomClass==false){throw new Error(""+b+" should be atom instance.")}this.name=a;this.value=b||null}ObarrayPair.prototype.toString=function(){return"("+this.name.toLisp()+" = "+(this.value&&this.value.toLisp())+")"};function VariableObarrayPair(){ObarrayPair.apply(this,arguments);this.varname=null}VariableObarrayPair.prototype=Object.create(ObarrayPair.prototype);VariableObarrayPair.prototype.getvarname=function(){if(this.varname==null){this.varname=inp.namegen.generate()}return this.varname};function Obarray(){this.obarray=[]}Obarray.prototype.find=function(b){var a;for(a=0;a<this.obarray.length;a++){if(this.obarray[a].name.toPlain()==b.toPlain()){return this.obarray[a]}}return null};Obarray.prototype.finde=function(a){var b;if((b=this.find(a))==null){throw new Error(""+a+" was not found.")}return b};Obarray.prototype.get=function(a){return this.finde(a).value};Obarray.prototype.getvarname=function(a){return this.finde(a).getvarname()};Obarray.prototype.set=function(a,c){var b;b=this.finde(a);return b.value=c,a};Obarray.prototype.add=function(a,b){if(this.find(a)==null){return this.addf(a,b)}return this.set(a,b)};Obarray.prototype.addf=function(a,b){this.obarray.unshift(new VariableObarrayPair(a,b));return this.set(a,b)};Obarray.prototype.length=function(){var a,b;for(a=0,b=this;b;b=b.parent){a+=1}return a};Obarray.prototype.toString=function(){var b,a,c;for(b="",a=0,c=this;c;c=c.parent){b+=""+(a++)+" deepness "+c.obarray.length+" items "+this.obarray.join(" ")+"\n"}return b};function Obarrays(a){this.parent=a||null;this.obarray=new Obarray()}Obarrays.prototype.find=function(a){var c,b;for(c=this;c;c=c.parent){if((b=c.obarray.find(a))){return b}}return null};Obarrays.prototype.finde=Obarray.prototype.finde;Obarrays.prototype.get=Obarray.prototype.get;Obarrays.prototype.getvarname=Obarray.prototype.getvarname;Obarrays.prototype.set=Obarray.prototype.set;Obarrays.prototype.add=Obarray.prototype.add;Obarrays.prototype.addf=function(a,b){return this.obarray.addf(a,b)};Obarrays.prototype.length=function(){var a,b;for(a=0,b=this;b;b=b.parent){a+=b.obarray.length()}return a};Obarrays.prototype.nest=function(){return new Obarrays(this)};Obarrays.prototype.exit=function(){return this.parent};Obarrays.prototype.toString=function(){var b,a,c;for(b="",a=0,c=this;c;c=c.parent){b+=""+(a++)+" deepness "+c.obarray.toString()}return b};function ReaderScope(a){this.scope={};this.method=a||null}ReaderScope.prototype.get=function(a){return this.scope[a.toString()]||null};ReaderScope.prototype.getcurrent=function(){return this.method||null};ReaderScope.prototype.dig=function(a){if(this.scope[a.toString()]==null){this.scope[a.toString()]=new ReaderScope()}return this.scope[a.toString()]};ReaderScope.prototype.set=function(a,b){return this.dig(a).setcurrent(b)};ReaderScope.prototype.setcurrent=function(a){return this.method=a};function Interpreter(){this.scopevar=new Obarrays();this.scopefunc=new Obarrays();this.readerscope=new ReaderScope();this.namegen=new NameGenerator("abcdefghijklmnopqrstuvwxyz")}Interpreter.prototype.nest=function(){this.scopevar=this.scopevar.nest();this.scopefunc=this.scopefunc.nest()};Interpreter.prototype.exit=function(){this.scopevar=this.scopevar.exit();this.scopefunc=this.scopefunc.exit()};var inp=new Interpreter();function onlisp(b){return function a(){try{strace.clear();return b.apply(this,arguments)}catch(c){strace.print();console.log("variable bindings = \n"+inp.scopevar.toString()+"");console.log("function bindings = \n"+inp.scopefunc.toString()+"");throw c}}}function readlisp(a){return rdread.evaluate(makestrstreamin(a))}function evallisp(a){return readlisp(a).evaluatearg()}function explisp(a){return readlisp(a).expandarg()}readlisp=onlisp(readlisp);evallisp=onlisp(evallisp);explisp=onlisp(explisp);var rest=makeintern("&rest");var optional=makeintern("&optional");var streamlook=new PrimitiveFunctionClass();var streamget=new PrimitiveFunctionClass();var streamput=new PrimitiveFunctionClass();streamlook.label="$stream-look";streamget.label="$stream-get";streamput.label="$stream-put";streamlook.onevaluate=function(a){return a.look()};streamget.onevaluate=function(a){return a.get()};streamput.onevaluate=function(a,b){return b.put(a)};streamlook.onexpand=function(){throw new Error(""+this+" cannot expand to the source code.")};streamget.onexpand=function(){throw new Error(""+this+" cannot expand to the source code.")};streamput.onexpand=function(){throw new Error(""+this+" cannot expand to the source code.")};var rdignoreindent=new PrimitiveFunctionClass();var rdread=new PrimitiveFunctionClass();var rdreaddefault=new PrimitiveFunctionClass();var rdreadintern=new PrimitiveFunctionClass();var rdreadminus=new PrimitiveFunctionClass();var rdreadnumber=new PrimitiveFunctionClass();var rdreadstring=new PrimitiveFunctionClass();var rdreadopenbrace=new PrimitiveFunctionClass();var rdreadclosebrace=new PrimitiveFunctionClass();var rdreadclosebrace_unique=new Unique();var rdreadquote=new PrimitiveFunctionClass();var rdreadquoteback=new PrimitiveFunctionClass();var rdreadunquote=new PrimitiveFunctionClass();var rdreadunquoteat=new PrimitiveFunctionClass();var rdreadchar=new PrimitiveFunctionClass();var rdreadpre=new PrimitiveFunctionClass();var rdreadnative=new PrimitiveFunctionClass();rdignoreindent.onevaluate=function(a){while(a.isalive()&&a.look().value==" ".charCodeAt()){a.get()}return nil};rdread.onevaluate=function(e){rdignoreindent.evaluate(e);var d,b;var c,a;for(d=inp.readerscope,c=nil;e.isalive();){a=e.look();b=d.get(a);if(b==null){break}c=e.get();d=b}if(d.getcurrent()==null){throw new Error("reader macro error.")}return d.getcurrent().evaluate(c,e)};rdreaddefault.onevaluate=function(b,c){var a;switch((a=c.get()).toString()){case",":switch((c.look()).toString()){case"@":return rdreadunquoteat.evaluate(c.get(),c);default:return rdreadunquote.evaluate(a,c)}case"'":return rdreadquote.evaluate(a,c);case"`":return rdreadquoteback.evaluate(a,c);case'"':return rdreadstring.evaluate(a,c);case"(":return rdreadopenbrace.evaluate(a,c);case")":return rdreadclosebrace.evaluate(a,c);case"-":return rdreadminus.evaluate(a,c);case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":return rdreadnumber.evaluate(a,c);default:return rdreadintern.evaluate(a,c)}};rdreadintern.onevaluate=function(b,c){var a=makelist(synif,b,b,makeexpanded("")).evaluatearg().toString();while(c.isalive()&&c.look().toString()!=" "&&c.look().toString()!="("&&c.look().toString()!=")"){a+=c.get().toString()}if(a.length==0){return nil}return makeintern(a)};rdreadminus.onevaluate=function(a){return makelist(basnumsub2,makeint(0),rdread.evaluate(a))};rdreadnumber.onevaluate=function(b,c){var a=b.toString();while(c.isalive()&&c.look().toString()=="0"||c.look().toString()=="1"||c.look().toString()=="2"||c.look().toString()=="3"||c.look().toString()=="4"||c.look().toString()=="5"||c.look().toString()=="6"||c.look().toString()=="7"||c.look().toString()=="8"||c.look().toString()=="9"||c.look().toString()=="."){a+=c.get().toString()}return(a.indexOf(".")>=0)?makefloat(parseFloat(a)):makeint(parseInt(a))};rdreadstring.onevaluate=function(b,d){var c,a;for(c="";d.isalive()&&(a=d.get()).toString()=='"';){c+=a}return makestring(c)};rdreadopenbrace.onevaluate=function(b,d){var a;var c;a=nil;while(true){if(d.isalive()==false){throw new Error("could not find close brace.")}c=rdread.evaluate(d);if(c==rdreadclosebrace_unique){break}a=makecons(c,a)}return a.reverse()};rdreadclosebrace.onevaluate=function(a,b){return rdreadclosebrace_unique};rdreadquote.onevaluate=function(a,b){return makelist(synquote,rdread.evaluate(b))};rdreadquoteback.onevaluate=function(a,b){return makelist(synquoteback,rdread.evaluate(b))};rdreadunquote.onevaluate=function(a,b){return new UnQuoteClass(rdread.evaluate(b))};rdreadunquoteat.onevaluate=function(a,b){return new UnQuoteAtClass(rdread.evaluate(b))};rdreadchar.onevaluate=function(a,b){return new CharClass(b.get())};rdreadpre.onevaluate=function(a,b){var c=rdread.evaluate(b);return c.evaluatearg()};rdreadnative.onevaluate=function(b,c){var a=rdread.evaluate(c);return new Expanded(a.name.toPlain())};inp.readerscope.setcurrent(rdreaddefault);var standard="";var synif=new SpecialFunctionClass();var synblock=new SpecialFunctionClass();var synprogn=new SpecialFunctionClass();var synsetf=new SpecialFunctionClass();var synquote=new SpecialFunctionClass();var synquoteback=new SpecialFunctionClass();var synlambda=new SpecialFunctionClass();var synmacro=new SpecialFunctionClass();inp.scopefunc.add(makeintern("if"),synif);inp.scopefunc.add(makeintern("block"),synblock);inp.scopefunc.add(makeintern("progn"),synprogn);inp.scopefunc.add(makeintern("setf"),synsetf);inp.scopefunc.add(makeintern("quote"),synquote);inp.scopefunc.add(makeintern("quoteb"),synquoteback);inp.scopefunc.add(makeintern("lambda"),synlambda);inp.scopefunc.add(makeintern("macro"),synmacro);synif.label="$if";synblock.label="$block";synprogn.label="$progn";synsetf.label="$setf";synquote.label="$quote";synquoteback.label="$quoteback";synlambda.label="$lambda";synmacro.label="$macro";synif.onevaluate=function(c,a,b){if(getreference(c.evaluatearg())!=nil){return getreference(a.evaluatearg())}return getreference(b.evaluatearg())};synif.onexpand=function(c,a,b){return new Expanded("("+c.expandarg()+"==null?"+b.expandarg()+":"+a.expandarg()+")")};synblock.onevaluate=function(){inp.nest();var a=synprogn.evaluate.apply(synprogn,arguments);inp.exit();return a};synblock.onexpand=function(){inp.nest();var a=synprogn.expand.apply(synprogn,arguments);inp.exit();return a};synprogn.onevaluate=function(){var b,a;for(b=nil,a=0;a<arguments.length;a++){b=arguments[a].evaluatearg()}return b};synprogn.onexpand=function(){var b,a;for(b="",a=0;a<arguments.length;a++){b+=(a?",":"")+arguments[a].expandarg()}return new Expanded("("+b+")")};synsetf.onevaluate=function(e,d){var b="set formula = "+e.toLisp()+" = "+d.toLisp()+"";strace.push(b);stracedb.push(b);var a=getreference(d.evaluatearg());var c=e.evaluatearg();return c.set(a)};synsetf.onexpand=function(e,d){var b="set formula expand = "+e.toLisp()+" = "+d.toLisp()+"";strace.push(b);stracedb.push(b);var a=getreference(d.evaluatearg());var c=e.evaluatearg();c.set(a);return new Expanded("("+c.expandarg()+"="+a.expandarg()+")")};synquote.onevaluate=function(b){var a="unquote "+b.toLisp()+"";strace.push(a);stracedb.push(a);return b};synquote.onexpand=function(a){return this.evaluate.apply(this,arguments).expanddata()};synquoteback.onevaluate=function(b){var a="unquoteback "+b.toLisp()+" = "+b.clone().toLisp()+"";strace.push(a);stracedb.push(a);return b.clone()};synquoteback.onexpand=function(a){return this.evaluate.apply(this,arguments).expanddata()};synlambda.onevaluate=function(a){return new UserFunctionClass(a,ConsClass.toCons(slice(arguments,1)))};synlambda.onexpand=function(a){return this.evaluate.apply(this,arguments).expandarg()};synmacro.onevaluate=function(a){return new UserMacroClass(a,ConsClass.toCons(slice(arguments,1)))};synmacro.onexpand=function(a){return this.evaluate.apply(this,arguments).expandarg()};var basdecvariable=new PrimitiveFunctionClass();var basdecfunction=new PrimitiveFunctionClass();basdecvariable.label="$declare-variable";basdecfunction.label="$declare-function";inp.scopefunc.add(makeintern("declare-variable"),basdecvariable);inp.scopefunc.add(makeintern("declare-function"),basdecfunction);var logdecvariable=new Log();var logdecfunction=new Log();basdecvariable.onevaluate=function(a){logdecvariable.push("(declare-variable "+a+")");return inp.scopevar.addf(a)};basdecfunction.onevaluate=function(a){logdecfunction.push("(declare-function "+a+")");return inp.scopefunc.addf(a)};var bassymbolfunction=new PrimitiveFunctionClass();var bassymbolvalue=new PrimitiveFunctionClass();var bassymbolname=new PrimitiveFunctionClass();var bassymbolintern=new PrimitiveFunctionClass();var bassymbolmake=new PrimitiveFunctionClass();bassymbolfunction.label="$symbol-function";bassymbolvalue.label="$symbol-value";bassymbolname.label="$symbol-name";bassymbolintern.label="$symbol-intern";bassymbolmake.label="$symbol-make";inp.scopefunc.add(makeintern("symbol-function"),bassymbolfunction);inp.scopefunc.add(makeintern("symbol-value"),bassymbolvalue);inp.scopefunc.add(makeintern("symbol-name"),bassymbolname);inp.scopefunc.add(makeintern("intern"),bassymbolintern);inp.scopefunc.add(makeintern("make-symbol"),bassymbolmake);bassymbolfunction.onevaluate=function(a){return new SymbolFunctionReferenceClass(a)};bassymbolvalue.onevaluate=function(a){return new SymbolValueReferenceClass(a)};bassymbolname.onevaluate=function(a){return a.name};bassymbolintern.onevaluate=function(a){return new InternSymbolClass(a)};bassymbolmake.onevaluate=function(a){return new SymbolClass(a)};standard+=makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,makeintern("nil")))),nil).expandarg();standard+=makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,makeintern("t")))),t).expandarg();var basadd=new PrimitiveFunctionClass();var bassub=new PrimitiveFunctionClass();var basnumadd2=new PrimitiveFunctionClass();var basnumsub2=new PrimitiveFunctionClass();var basnummul2=new PrimitiveFunctionClass();var basnumdiv2=new PrimitiveFunctionClass();var basnummod2=new PrimitiveFunctionClass();var basnumand2=new PrimitiveFunctionClass();var basnumor2=new PrimitiveFunctionClass();var basnumnot2=new PrimitiveFunctionClass();var basnumeq2=new PrimitiveFunctionClass();var basnumless2=new PrimitiveFunctionClass();var basnumlesseq2=new PrimitiveFunctionClass();var basnumlarge2=new PrimitiveFunctionClass();var basnumlargeq2=new PrimitiveFunctionClass();var basintadd2=new PrimitiveFunctionClass();var basintsub2=new PrimitiveFunctionClass();var basintmul2=new PrimitiveFunctionClass();var basintdiv2=new PrimitiveFunctionClass();var basintmod2=new PrimitiveFunctionClass();var basintand2=new PrimitiveFunctionClass();var basintor2=new PrimitiveFunctionClass();var basintnot2=new PrimitiveFunctionClass();var basfloatadd2=new PrimitiveFunctionClass();var basfloatsub2=new PrimitiveFunctionClass();var basfloatmul2=new PrimitiveFunctionClass();var basfloatdiv2=new PrimitiveFunctionClass();basnumeq2.onevaluate=function(d,c){return(d.value==c.value)?t:nil};basnumless2.onevaluate=function(d,c){return(d.value<c.value)?t:nil};basnumlesseq2.onevaluate=function(d,c){return(d.value<=c.value)?t:nil};basnumlarge2.onevaluate=function(d,c){return(d.value>c.value)?t:nil};basnumlargeq2.onevaluate=function(d,c){return(d.value>=c.value)?t:nil};basfloatadd2.onevaluate=function(d,c){return new FloatClass(d.value+c.value)};basfloatsub2.onevaluate=function(d,c){return new FloatClass(d.value-c.value)};basfloatmul2.onevaluate=function(d,c){return new FloatClass(d.value*c.value)};basfloatdiv2.onevaluate=function(d,c){return new FloatClass(d.value/c.value)};basintadd2.onevaluate=function(d,c){if(c instanceof IntClass){return new IntClass(d.value+c.value)}return basnumadd2.evaluate(c,d)};basintsub2.onevaluate=function(d,c){if(c instanceof IntClass){return new IntClass(d.value-c.value)}return basnumsub2.evaluate(c,d)};basintmul2.onevaluate=function(d,c){if(c instanceof IntClass){return new IntClass(d.value*c.value)}return basnummul2.evaluate(c,d)};basintdiv2.onevaluate=function(d,c){if(c instanceof IntClass){return new IntClass(d.value/c.value)}return basnumdiv2.evaluate(c,d)};basintmod2.onevaluate=function(d,c){if(c instanceof IntClass){return new IntClass(d.value%c.value)}return basnummod2.evaluate(c,d)};basintand2.onevaluate=function(d,c){if(c instanceof IntClass){return new IntClass(d.value&c.value)}return basnumand2.evaluate(c,d)};basintor2.onevaluate=function(d,c){if(c instanceof IntClass){return new IntClass(d.value|c.value)}return basnumor2.evaluate(c,d)};basintnot2.onevaluate=function(b){return new IntClass(~b.value)};var basfnfuncall=new SpecialFunctionClass();var basfnapply=new SpecialFunctionClass();basfnfuncall.label="$funcall";basfnapply.label="$apply";inp.scopefunc.add(makeintern("funcall"),basfnfuncall);inp.scopefunc.add(makeintern("apply"),basfnapply);basfnfuncall.onevaluate=function(b){var a=b.evaluatearg();return a.evaluate.apply(a,slice(arguments,1))};basfnfuncall.onexpand=function(a){return a.expand.apply(a,slice(arguments,1))};basfnapply.onevaluate=function(c,b){var a=c.evaluatearg();return a.evaluate.apply(a,b.toArray())};basfnapply.onexpand=function(b,a){return b.expand.apply(b,ConsClass.toCons(a))};var basprint=new PrimitiveFunctionClass();var basstrace=new PrimitiveFunctionClass();var basstracedb=new PrimitiveFunctionClass();basprint.label="$print";basstrace.label="$strace";basstracedb.label="$stracedb";inp.scopefunc.add(makeintern("print"),basprint);inp.scopefunc.add(makeintern("strace"),basstrace);inp.scopefunc.add(makeintern("stracedb"),basstracedb);basprint.onevaluate=function(a){console.log(a.toLisp());return a};basstrace.onevaluate=function(){strace.print();return nil};basstracedb.onevaluate=function(){stracedb.print();return nil};basprint.onexpand=function(a){return makelist(synprogn,makelist(new Expanded("console.log"),a),a).expandarg()};basstrace.onexpand=function(){basstrace.evaluate.apply(this,arguments);return nil.expandarg()};basstracedb.onexpand=function(){basstracedb.evaluate.apply(this,arguments);return nil.expandarg()};var baseq2=new PrimitiveFunctionClass();baseq2.label="$eq2";baseq2.onevaluate=function(d,c){return d==c?t:nil};baseq2.onexpand=function(d,c){return new Expanded("("+d+"==="+c+")")};var basconconsp=new PrimitiveFunctionClass();var basconcons=new PrimitiveFunctionClass();var basconcar=new PrimitiveFunctionClass();var basconcdr=new PrimitiveFunctionClass();var basconlist=new PrimitiveFunctionClass();inp.scopefunc.add(makeintern("cons"),basconcons);inp.scopefunc.add(makeintern("car"),basconcar);inp.scopefunc.add(makeintern("cdr"),basconcdr);inp.scopefunc.add(makeintern("list"),basconlist);basconcons.label="$cons";basconcar.label="$car";basconcdr.label="$cdr";basconlist.label="$list";basconconsp.onevaluate=function(a){return a instanceof ConsClass?t:nil};basconcons.onevaluate=function(a,b){return new ConsReferenceClass(new ConsClass(a,b))};basconcar.onevaluate=function(a){return new ConsCarReferenceClass(a)};basconcdr.onevaluate=function(a){return new ConsCdrReferenceClass(a)};basconcons.onexpand=function(a,b){return new Expanded("new Cons("+a+","+b+")")};basconcar.onexpand=function(a){return this.evaluate.apply(this,arguments).expandarg()};basconcdr.onexpand=function(a){return this.evaluate.apply(this,arguments).expandarg()};basconlist.onevaluate=function(){return new ConsReferenceClass(ConsClass.toCons(arguments))};standard+=makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,makeintern("nil")))),nil).expandarg();standard+=makelist(synsetf,makelist(bassymbolvalue,makelist(basdecvariable,makelist(synquote,makeintern("t")))),t).expandarg();evallisp("(setf (symbol-function 'defun) (macro (name &rest rest) `(setf (symbol-function (declare-function (quote ,name))) (lambda ,@rest))))");evallisp("(setf (symbol-function 'defmacro) (macro (name &rest rest) `(setf (symbol-function (declare-function (quote ,name))) (macro ,@rest))))");evallisp("(defmacro defvar (name value) `(setf (symbol-value (declare-variable (quote ,name))) ,value))");evallisp("(defmacro setq (name value) `(setf (symbol-value (quote ,name)) ,value))");evallisp("(defmacro set-car (con value) `(setf (car ,con) ,value))");evallisp("(defmacro set-cdr (con value) `(setf (cdr ,con) ,value))");evallisp("(defmacro caar (con) `(car (car ,con)))");evallisp("(defmacro cdar (con) `(cdr (car ,con)))");evallisp("(defmacro cadr (con) `(car (cdr ,con)))");evallisp("(defmacro cddr (con) `(cdr (cdr ,con)))");evallisp("(defmacro null (value) `(if ,value nil t))");evallisp("(defmacro not (value) `(if ,value nil t))");evallisp("(defmacro and (&rest rest) (if (null rest) t (if (null (cdr rest)) (car rest) `(if ,(car rest) (and ,@(cdr rest)) nil))))");evallisp("(defmacro or (&rest rest) (if (null rest) nil (if (null (cdr rest)) (car rest) `(if ,(car rest) ,(car rest) (or ,@(cdr rest))))))");evallisp("(defmacro when (status &rest rest) `(if ,status (progn ,@rest) nil))");evallisp("(defmacro unless (status &rest rest) `(if ,status nil (progn ,@rest)))");evallisp("(defmacro cond (&rest rest) (if (null rest) nil `(if ,(caar rest) (progn ,@(cdar rest)) (cond ,@(cdr rest)))))");evallisp("(defmacro push (value sym) `(setq ,sym (cons ,value ,sym)))");evallisp("(defmacro pop (sym) `(prog1 (car ,sym) (setq ,sym (cdr ,sym))))");standard+=explisp("(defun copy (seq) (cons (car seq) (copy (cdr seq))))");standard+=explisp("(defun map (func seq) (and seq nil (cons (funcall func (car seq)) (map func (cdr seq)))))");standard+=explisp("(defun filter (func seq) (and seq nil (if (funcall func (car seq)) (cons (car seq) (filter func (cdr seq))) (filter func (cdr seq)))))");standard+=explisp("(defun foreach (func seq) (and seq (funcall (car seq)) (foreach func (cdr seq))))");standard+=explisp("(defun reduce (func seq) (and seq (reducein func (car seq) (cdr seq))))");standard+=explisp("(defun reducein (func sum seq2) (if (null seq2) sum (reducein func (funcall func sum (car seq2)) (cdr seq2))))");standard+=explisp("(defun find-if (func seq) (and seq (if (funcall (car seq)) (car seq) (find-if func (cdr seq)))))");standard+=explisp("(defun position-if (func cons) (position-ifin func cons 0))");standard+=explisp("(defun position-ifin (func cons count) (and cons (if (funcall func (car cons)) count (position-ifin func (cdr cons) (+1 count)))))");standard+=explisp("(defun append2 (seq seqe) (if (null seq) seqe (cons (car seq) (append2 (cdr seq) seqe))))");standard+=explisp("(defun append (&rest seqs) (reduce 'append2 seqs))");standard+=explisp("(defun reverse (seq) (and seq (cons (car seq) (reverse (cdr seq)))))");evallisp("(defmacro let (binds &rest rest) `(block ,@(letin binds rest)))");evallisp("(defmacro flet (binds &rest rest) `(block ,@(fletin binds rest)))");evallisp("(defmacro mlet (binds &rest rest) `(block ,@(mletin binds rest)))");evallisp("(defun letin (binds rest) (if (null binds) (if rest rest '(nil))(cons `(setf (symbol-value (declare-variable (quote ,(caar binds)))) ,(car (cdar binds))) (letin (cdr binds) rest)))))");evallisp("(defun fletin (binds rest) (if (null binds) (if rest rest '(nil))(cons `(setf (symbol-function (declare-variable (quote ,(caar binds)))) (lambda ,@(cdar binds))) (letin (cdr binds) rest)))))");evallisp("(defun mletin (binds rest) (if (null binds) (if rest rest '(nil))(cons `(setf (symbol-function (declare-variable (quote ,(caar binds)))) (macro ,@(cdar binds))) (letin (cdr binds) rest)))))");evallisp("(defmacro prog1 (bind &rest rest) `(let ((temp ,bind)) ,@rest temp))");